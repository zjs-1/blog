---
layout: title
title: 业务架构优化点
date: 2018-06-18 14:29:34
tags: [架构]
categories: 技术
---

![BT现架构](http://cdn.jsblog.site/BT现架构.png)

### 基础业务逻辑靠前，导致业务代码重复、行为不一致

**问题：**
典型的例子有购课、题库，官网与APP有同样的业务，但是代码却存在两份，导致多端之间行为不一致。
购课最终通过统一到sheep解决问题，题库通过多个版本的调整使行为达到一致。

**解决方法：**
这个问题的出现比较大比例是历史原因，问题的出现已经是无法避免，只能想办法解决：

1. 通用业务逻辑代码下沉，典型的如`用户业务`、`题库业务`、`购课业务`等，应该下沉至服务层。
2. 个性化、定制化的业务应该上浮，如 `APP题库` 可能相较于 `官网题库` 有不同的做题行为，这类特殊的行为应该出现在Sierra中。

### 服务层的改进

**问题：**
为了解决上一个问题，我们已经开始下意识地使系统`服务化`，`MicroService`是里面最重要的一环，但是实践过程中问题不少。

1. 大量基础业务服务待补充: 比如`任务服务`需要`用户服务`的支持，但是在开发`任务服务`的时候，并没有现成的`用户服务`，只能临时**耦合**在`任务服务`内，或者建一个**不稳定**的`用户服务`；
2. 基础业务服务的划分不清晰: 比如`bookDelivery`可能不适合作为一个基础业务服务(我对该业务不是特别了解，主观判断举例而已)，`ms-course-member`业务功能不明确。
3. 服务间的调用: 目前服务间的调用使用的是co-common里的一个请求方法，服务间用HTTP协议进行调用。该方法已经明确的问题有: 服务路由接口管理不便、服务间依赖严重。而且目前还缺少一个统一的参数协议。
4. 日志不统一，没有监测、报警机制: 目前的日志的作用更多的是debug。

**解决方法:**

这一块我也不知道有什么可行的解决方法，尝试从网上寻找成熟的微服务开源框架或者针对某个特定问题寻找解决方案。下面说说解决方案可能应该满足的点:

1. 首先是服务的划分: `领域驱动`似乎是一个解决方案，目前还在了解，怎么应用到微服务中还没有了解到。
2. 然后是服务的部署: 理所当然地服务`docker化`可以便于部署，然后便是部署后的服务治理、监控，这个大部分微服务框架应该都有。
3. 服务间的调用: 初步想法是引入队列，减少服务间的耦合，强相关的内容尽量划分为同个服务，实在不行再使用`分布式事务`(实现较为复杂)，弱相关的直接使用`事件队列`。
4. 服务日志监控: 统一日志规则(可用于日志分析)，建立日志管理平台，增加日志报警。
5. 服务接口测试: 这一块算老生常谈了。

除了上面的点，个人理解，`基础服务层`应该要有足够的**稳定性**，不应该频繁改动。在确定好基础架构之后，应该**优先完善基础服务**，如果在做`顶层业务`的时候，对`基础业务`进行修修补补，会影响整个基础服务的**统一性和稳定性**。

### 数据层的优化

**问题:**
`读写分离延迟`带来的问题，某些数据表过于庞大带来的问题。

**解决方案:**

1. 研究是否引入数据库中间件，似乎可以进行分库分表，解决读写分离延迟问题。
2. 写代码时尽量避免可能由于读写分离带来的问题。
3. 研究下数据库`命令查询职责分离模式(CQRS)`是否值得使用。

### 另外一些点

1. 希望官网可以进行改版，由`后端渲染`改为`前端渲染`，这种感觉越来越迫切。但是不改暂时也不会带来什么后果。
2. 系统地对订单进行梳理，可能需要进行一些改动，目前的专题订单在退课退款方面没有尽善尽美。这一块内容虽然已经趋于稳定，但还是不太放心，专题课程当时算是匆忙上线，随后又在该基础上增加了组合课程。
3. 圈子、优惠券等官网原有内容，希望可以找个契机洗牌重来，看了圈子部分代码，代码质量不高，不少地方存在缺陷。优惠券有些逻辑可能并不科学，比如优惠券需要先生成号码，无法一次生成大量等。


