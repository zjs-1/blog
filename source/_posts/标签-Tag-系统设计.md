---
layout: title
title: 标签(Tag)系统设计
date: 2018-06-27 16:32:52
tags: [技术文档]
categories: 技术
---

| Time | Version | Intro | Author | 
| :-: | :-: | :-: | :-: |
| 18-07-06 | v0.1 | 草稿版 | 千 | 
| 18-07-09 | v0.2 | 基于上一版增加了标签分组以及引用数量相关内容 | 千 |
| 18-07-25 | v0.3 | 针对运营标签应用增加接口 | 千 |
| 18-08-07 | v0.4 | 标签允许拥有多个标签类型 | 千 |

## 1. 背景

1. 运营需要向购买过特定分类课程的学员进行推送信息，比如CPA学员、法考学员等。通过`course_member`(学员课程信息)也可以做到定向推送，但是不太容易作为做成一个通用功能。

2. 为了便于题库的整理，题库系统引入知识点概念，一道题目可以拥有多个知识点，知识点希望以树形结构组织。

## 2. 名词解释

### 2.1 标签

用于标明某个实体信息的一组关键词。常见的如`男人`,`学生`,`付费用户`等用户标签，系统可以用标签来描述内容和检索内容。

### 2.2 标签主体

标签的拥有者。比如小明拥有学生标签，题目#11拥有会计标签，里面的小明、题目#11就是标签主体。

### 2.3 标签类型

<!--change by 千 v0.4-->
<!--标签主体的类型。`用户标签`、`课程标签`、`题目标签`等就是标签类型，我们只能给用户打`用户标签`，给课程打`课程标签`。-->
标签主体的类型。`用户标签`、`课程标签`、`题目标签`等就是标签类型，一个标签允许拥有多种标签类型，典型场景为: 知识点标签的主体可以是课时, 也可以是题目。

### 2.4 标签分组

标签分组决定了标签的使用场景，标签分组可能有`课程分组`、`活动分组`、`题库分组`等。

### 2.5 标签类型与标签分组的区别

从以下几个使用场景应该可以看出区别:

1. 运营想让购买了某课程的用户拥有某些标签，此时应该从`课程分组`里取出`用户标签`供运营选择;
2. 运营想给课程打上某些标签，用于课程推荐等功能，此时应该从`课程分组`里取出`课程标签`供运营选择;
3. 运营要给题库的题目打上标签，应该从`题库分组`里取出`题目标签`供运营选择;
4. 运营想给拥有某个题库的用户打上某些标签，应该从`题库分组`里取出`用户标签`供运营选择;

<!--change by 千--> 
<!--**一个标签只对应一种标签类型，只归属于一个标签分组**-->
**一个标签可以对应多种标签类型，只归属于一个标签分组**

### 2.6 标签引用数

某一主体对某一标签的拥有情况。主要便于在移除标签时对主体标签的处理。

如小明购买18年会计小班，拥有了会计标签，此时小明对会计标签的引用数为1。
随后小明又购买了18年会计小课，此时将小明对会计标签的引用数+1，变成2。
小明发现课程内容相近，于是退掉了会计小班，此时小明还是拥有会计标签，但是引用数减为1。
小明临时有事，今年会计决定弃考，把会计小课也一起退掉了，此时对会计标签的引用数降为0，标签移除。


## 3. 需求

以下需求为标签系统的需求，跟具体业务逻辑无关，比如户标签、题库标签等。

### 3.1 标签管理

#### 3.1.1 添加标签

由运营人员直接增加标签。

#### 3.1.2 删除标签

由运营人员直接删除标签，拥有该标签的内容应该同时取消关联。

#### 3.1.3 查看标签

获取标签主体。

#### 3.1.4 编辑标签 (不影响标签与内容的关联)

1. 修改标签名称
2. ~~修改标签顺序~~ (题目标签的需求，顺序不属于常规标签的属性，故不考虑该需求，可通过顶层业务逻辑做延伸实现)
3. ~~标签层级~~ (同样来自题目标签的需求，出于复杂性考虑标签系统内先不考虑该需求)

### 3.2 标签分组管理

标签拥有分组概念，分组决定标签使用场景，如课程、活动、题库等。

#### 3.2.1 添加标签分组 (仅技术使用)

新建一个新的标签分组。

#### 3.2.2 查看标签分组

查看标签分组列表，以及标签分组下拥有哪些标签

#### 3.2.3 编辑标签分组

更改标签分组名称、备注等信息

#### ~~3.2.4 删除标签分组~~

不提供该操作

### 3.3 打标签

**如果主体没有该标签，则打上标签，引用数记为1。如果主体已经拥有该标签，引用数+1**

#### 3.3.1 主动触发

如题目标签，为运营人员主动给题目打上标签。

#### 3.3.2 被动触发

如用户标签，用户购买课程之后，标签服务触发购课事件，为用户打上课程标签。

### 3.4 移除标签

退课等操作可能会触发移除标签的操作，**移除标签时应将主体标签引用数-1，当引用数为0，对标签进行移除。**

### 3.5 基于标签进行内容搜索

#### 3.5.1 单标签搜索

搜索拥有某个标签的内容。

#### 3.5.2 多标签`与`搜索

搜索同时拥有多个标签的内容。

#### 3.5.3 多标签`或`搜索 (业务暂无该需求)

搜索拥有标签中任意一个的内容。

## 3. 设计方案

### 3.1 设计考虑因素

1. 较高的性能: 前期标签数量不多，全面应用后可能爆炸性增长，需要考虑性能方面的要求。
2. 通用性: 标签系统可能会应用于很多内容，作为一个基础的业务服务，后期最好能够仅作出细微改动甚至不改动就能满足新的需求。

### 3.2 数据库选择

**使用mysql作为数据持久化存储**

优点:
1. 简单, 团队熟悉程度较高;
2. 较稳定;

缺点:
1. 对于复杂的搜索条件，对应的搜索语句比较晦涩;
2. 效率相比于`redis`较低，后期数据量大了可能性能会成为瓶颈; (短期内性能不会成为主要问题，出现问题可以尝试增加缓存缓解，同时从代码层面保证可以较轻松地切换至其他数据库)

### 3.3 数据库设计

**tag_group**

标签分组表

| key | comment | value |
| :-: | :-: | :-: |
| id | 标签分组ID |  |
| name | 标签分组名 | 字符串 |
| code | 标签分组的标识，主要用于代码中 | 字符串 |
| remark | 标签分组备注 | 字符串 |

**tag**

| key | comment | value |
| :-: | :-: | :-: |
| id | 标签ID |  |
| name | 标签名称 | 字符串 |
| type | 标签类型 | \|user\|question\| (字符串，用`|`隔开) |
| groupId | 标签分组ID | {tag_group表ID} |
<!--change by 千 v0.4-->
<!--| type | 标签类型 | [user, question, course] |-->


-----

> 后期可以根据ownerType进行数据库分表

**tag_owner**

| key | comment | value |
| :-: | :-: | :-: |
| ownerType | 标签类型 | [user, question, course] |
| ownerId | 内容ID | {user表ID} 或者 {question表ID} |
| tagId | 标签ID | {tag表ID} |
| referenceNum | 引用数量 | [1...∞] |

-----

> 这个表暂时不用建，后面服务间使用事件队列可以考虑这种方式，被动触发打标签

**tag_event**

| key | comment | value |
| :-: | :-: | :-: |
| name | 事件名称 | 字符串(addCourseMember等等) |
| key | 触发内容 | 字符串(course-161) |
| tag | 增加的标签 | {tag表ID} |

### 3.4 接口设计

> 以REST标准设计API
> 后面完善成swagger

-----
标签管理

| 资源 | 方法 | 含义 | 函数名 |
| :-: | :-: | :-: | :-: |
| /tags | POST | 新建标签 | addTag |
| /tags | GET | 获取标签列表 | getTagList |
| /tags/{id} | GET | 获取标签信息 | getTagById |
| /tags/{id} | PATCH | 修改标签信息 | updateTag |
| /tags/{id} | DELETE | 删除标签 | deleteTag |

-----
标签分组管理

| 资源 | 方法 | 含义 | 函数名 |
| :-: | :-: | :-: | :-: |
| /tag-groups | POST | 新建标签分组 | addTagGroup |
| /tag-groups | GET | 获取标签分组列表 | getTagGroupList |
| /tag-groups/{id} | PATCH | 编辑标签分组信息 | updateTagGroup |
| /tag-groups/{id} | GET | 获取标签分组信息 | getTagGroupById |

-----
标签关联管理

| 资源 | 方法 | 含义 | 函数名 |
| :-: | :-: | :-: | :-: |
| /tags/{id}/owners/{ownerType} | GET | 获取标签关联主体 | getTagOwnerListByTagId |
| /multi-tags/union/owners/{ownerType} | GET | 获取多个标签(并集关系)所关联内容 | getTagOwnerListByMultiTagsUnion |
| /tags/{id}/owners/{ownerType}/{ownerId} | POST | 打标签 | addTagOwner |
| /multi-tags/multi-owners/{ownerType} | POST | 对多个主体同时打上多个标签 | addMultiTagOwners |
| /tags/{id}/owners/{ownerType}/{ownerId} | DELETE | 删除标签关联(不管referenceNum，直接删除关联) | deleteTagOwnerByTagIdAndOwnerId |
| /tags/{id}/owners/{ownerType}/{ownerId}/reference/reduction | POST | 减少标签关联的referenceNum，当为0的时候将删除 | reduceTagOwnerReferenceNum |
| /tag-owners/{ownerType}/{ownerId} | DELETE | 取消该内容的所有标签关联 | deleteAllTagOwnersByOwnerId |
| /tag-owners/{ownerType}/{ownerId} | GET | 获取某个主体关联的标签 | getTagOwnersByOwnerId |
<!--change by 千 v0.4-->
<!--| /tags/{id}/owners | GET | 获取标签关联主体 | getTagOwnerListByTagId |
| /multi-tags/union/owners | GET | 获取多个标签(并集关系)所关联内容 | getTagOwnerListByMultiTagsUnion |-->



