---
layout: title
title: 记一次做动效
date: 2019-08-19 12:18:02
tags: [前端]
categories: 技术
---

在最近的项目里，主要是做APP的内嵌网页，作为移动端的网页，里面有不少的交互动效，其中一个实现效果如下:

[动画展示](http://cdn.jsblog.site/%E5%8A%A8%E7%94%BB%E5%B1%95%E7%A4%BA.mov)

因为没有太多经验，所以在这个动画上做了多次尝试，最终才勉强够到预期，因此觉得需要做一次记录。

## 第一次尝试

一开始先设计了一个最简单的方案，第一个页面点击的时候，图标变大、位移到指定位置，页面跳转，第二个页面出现。

这个方案实现起来很简单，根据点击给元素加上对应的class，利用css就能够完成动效，但是很快就发现了问题。
如下图，A、B是分别两个区块，其中B的外层有`overflow:hidden`属性，当图标移动到指定位置的时候，图标会有一部分超出区块，显示不全。

![-w200](http://cdn.jsblog.site/15661420296303.jpg)

## 第二个方案

第一个方案明显就不能通过，大概评估了下，为了动画修改整体布局，也不可行，只能绕过去。

很快又出来第二个方案，在点击图标的时候，复制一个图标，插入到body元素里，并且隐藏原始图标。然后还是利用css完成动画效果，时间到了便跳转页面。

这个方案实现出来之后，效果差强人意，主要有以下问题: 
1. 插入元素的时候，使用了原生的`appendChild`方法，该方法并不能同步插入元素，而且没有提供回调方法。因此只能通过`setTimeout`来延迟元元素的后续操作，而且实践后发现，所需延迟时间不固定，只能定一个稍长的时间。
2. 因为动画是用css来实现的，js内无法确定动画是否已经完成，也就不能准确知道什么时候该跳转页面，因此同样只能大概定一个时间，`setTimeout`进行跳转。

综上原因，动效虽然能够实现，但是在点击之后、元素位移完成之后，视觉均有不同程度的卡顿。

## 第三个方案

有问题就解决问题，第三个方案主要是针对方案二的问题进行解决。

1.appendChild`延时问题

临时插入元素需要延时，那就在组件挂载的时候，先把元素都复制一份就好了，然后隐藏元素，当点击的时候，元素只需要修改位置、是否可见等css样式，便可以快速出现。

2.css动画时间不可把握

那就干脆换掉css动画，找一个好用的js动画库来替代，在罗威的推荐下，选择了`animejs`。

两个问题解决了，在电脑上看效果还不错，但是拿到真机上一试，感觉还是不够流畅，主要在于元素隐藏之后，出现第二个页面的时候，没办法无缝衔接，所以看起来就有卡顿。

这个时候还以为是页面元素太多，手机性能较差，无法完成流畅的动画，已经放弃优化了。

## 方案优化

在离开电脑的时候，突然发现之前自己进入了误区。vue是单页面应用，虽然A页面到B页面看起来是一次页面跳转，但实际上还是在同个应用内。

而且在A页面里，用原生js生成的元素，并不会随着页面的跳转而消失，也就是说，我们完全有能力利用这些元素来做障眼法，完成页面的无缝衔接。

大概梳理了下，把整个动画拆分成了几个部分，如下: 

0-200ms:  使用一个白色遮罩(夜间模式下是黑色)，挡住整个可视区，不透明度由0到1，从而实现A页面的淡出。
0-250ms: 复制的图标进行形变和位移，必须准确无误地移动到B页面对应元素的位置。

此时，视觉效果上就只剩下位移后的图标了。

275ms 时进行页面跳转，比250ms多了25ms，主要是为了保证位移已经完成。这也是之前出现卡顿的原因之一，当页面跳转的时候，网页元素会有很大的变化，如果位移动画没有完成便会很卡。

350ms-500ms 白色遮罩背景逐渐透明，最后直接隐藏，B页面逐渐显现，此时B页面大概率已经加载完成。

把动画拆解完之后，实现起来就很简单了，最后实现出来的效果还是比较符合要求的。

## 总结

做这个动画花了不少时间，主要还是没有掌握方法。第一步最好还是先做动画的拆解，而且不能被表面的东西所束缚。
